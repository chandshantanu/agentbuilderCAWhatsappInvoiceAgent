import{R as z,s as e,Q as $,r as l,C as ie,z as Fe}from"./index-Bp_UmaCL.js";import{u as Se,L as g,S as ne,a as re,b as le,c as ce,d as ee}from"./select-Crm1tiLE.js";import{I as p,B as N}from"./input-GzHbweEW.js";import{B as Q}from"./badge-BsIsCzmH.js";import{D as Le,a as Pe,b as De,c as Ee,d as ze}from"./dialog-lCjlVtjM.js";import{S as oe}from"./skeleton-C6b0Brwr.js";import{c as k}from"./caInvoiceService-09kBxQwV.js";import{S as Be}from"./search-hwF9FksX.js";import{C as we,a as Ge,S as Ue}from"./sliders-horizontal-DtQDuVUp.js";import{C as de}from"./chevron-right-Bat6XS3b.js";import{A as Oe}from"./alert-triangle-Dll20bIf.js";import{P as $e}from"./plus-CPAcQCsh.js";import{T as He}from"./trash-2-DMkfF4m9.js";import{I as Ce}from"./image-CYuOe6MX.js";import"./index-CvZeWDWn.js";const xe=z.forwardRef(({className:r,...n},c)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:c,className:$("w-full caption-bottom text-sm",r),...n})}));xe.displayName="Table";const me=z.forwardRef(({className:r,...n},c)=>e.jsx("thead",{ref:c,className:$("[&_tr]:border-b",r),...n}));me.displayName="TableHeader";const he=z.forwardRef(({className:r,...n},c)=>e.jsx("tbody",{ref:c,className:$("[&_tr:last-child]:border-0",r),...n}));he.displayName="TableBody";const E=z.forwardRef(({className:r,...n},c)=>e.jsx("tr",{ref:c,className:$("border-b transition-colors hover:bg-gray-50/50",r),...n}));E.displayName="TableRow";const x=z.forwardRef(({className:r,...n},c)=>e.jsx("th",{ref:c,className:$("h-12 px-4 text-left align-middle font-medium text-gray-500 [&:has([role=checkbox])]:pr-0",r),...n}));x.displayName="TableHead";const o=z.forwardRef(({className:r,...n},c)=>e.jsx("td",{ref:c,className:$("p-4 align-middle [&:has([role=checkbox])]:pr-0",r),...n}));o.displayName="TableCell";const Ie={pending_user_confirmation:"bg-purple-100 text-purple-800",pending_review:"bg-orange-100 text-orange-800",approved:"bg-green-100 text-green-800",rejected:"bg-red-100 text-red-800",exported:"bg-blue-100 text-blue-800"},Me=["Sales","Purchase","Credit Note","Debit Note","Receipt","Payment","Journal"],Ye=["Intra-State","Inter-State"],d=r=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"}).format(r);function Ve(r){const n=Math.round(r*100);return n>=90?e.jsxs(Q,{className:"bg-green-100 text-green-800 text-xs",children:[n,"% confidence"]}):n>=70?e.jsxs(Q,{className:"bg-amber-100 text-amber-800 text-xs",children:[n,"% confidence"]}):e.jsxs(Q,{className:"bg-red-100 text-red-800 text-xs",children:[n,"% confidence"]})}function qe(){return{description:"",hsn_sac_code:"",quantity:1,unit:"NOS",rate:0,taxable_amount:0,gst_rate:18,cgst_amount:0,sgst_amount:0,igst_amount:0,cess_amount:0,total_amount:0}}function be(r,n){const c=r.quantity*r.rate,m=c*(r.gst_rate/100);return{...r,taxable_amount:c,cgst_amount:n?0:m/2,sgst_amount:n?0:m/2,igst_amount:n?m:0,total_amount:c+m+r.cess_amount}}function Je({src:r,alt:n,className:c}){const[m,S]=l.useState(null),[A,y]=l.useState(!1);return l.useEffect(()=>{if(!r)return;let j=!1;return Fe.get(r,{responseType:"blob"}).then(v=>{j||S(URL.createObjectURL(v.data))}).catch(()=>{j||y(!0)}),()=>{j=!0}},[r]),l.useEffect(()=>()=>{m&&URL.revokeObjectURL(m)},[m]),A?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-400 gap-2 py-12",children:[e.jsx(Ce,{className:"h-10 w-10"}),e.jsx("p",{className:"text-sm",children:"Failed to load preview"})]}):m?e.jsx("img",{src:m,alt:n,className:c,loading:"lazy"}):e.jsx(oe,{className:"h-96 w-full"})}function Qe({invoiceId:r}){const[n,c]=l.useState(0),[m,S]=l.useState(0),[A,y]=l.useState(!0),[j,v]=l.useState(!1);if(l.useEffect(()=>{let t=!1;return y(!0),v(!1),k.getInvoiceMediaCount(r).then(H=>{t||(c(H),y(!1))}).catch(()=>{t||(c(0),y(!1),v(!0))}),()=>{t=!0}},[r]),A)return e.jsx("div",{className:"flex items-center justify-center h-full bg-gray-50 rounded-lg",children:e.jsx(oe,{className:"h-96 w-full"})});if(j||n===0)return e.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 rounded-lg text-gray-400 gap-2 py-12",children:[e.jsx(Ce,{className:"h-10 w-10"}),e.jsx("p",{className:"text-sm",children:"No document preview available"})]});const B=k.getInvoiceMediaUrl(r,m);return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"flex-1 bg-gray-100 rounded-lg overflow-hidden flex items-center justify-center min-h-[400px]",children:e.jsx(Je,{src:B,alt:`Invoice page ${m+1}`,className:"max-w-full max-h-[70vh] object-contain"})}),n>1&&e.jsxs("div",{className:"flex items-center justify-center gap-3 mt-2",children:[e.jsx(N,{size:"sm",variant:"outline",disabled:m===0,onClick:()=>S(t=>t-1),children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsxs("span",{className:"text-sm text-gray-500",children:["Page ",m+1," of ",n]}),e.jsx(N,{size:"sm",variant:"outline",disabled:m>=n-1,onClick:()=>S(t=>t+1),children:e.jsx(de,{className:"h-4 w-4"})})]})]})}function Ze({invoice:r,allInvoices:n,onClose:c,onApprove:m,onReject:S,onSaved:A}){var _e,ye;const{toast:y}=Se(),j=z.useMemo(()=>{if(!r)return[r];const s=r.wa_message_id,u=r.media_file_ids||[];if(s){const h=n.filter(F=>F.wa_message_id===s);if(h.length>1)return h}if(u.length>0){const h=JSON.stringify([...u].sort()),F=n.filter(D=>JSON.stringify([...D.media_file_ids||[]].sort())===h);if(F.length>1)return F}return[r]},[r,n]),[v,B]=l.useState(()=>Math.max(0,j.findIndex(s=>s.id===r.id))),t=j[v]||r,H=j.length>1,i=t.status==="pending_review"||t.status==="pending_user_confirmation",I=(((_e=t.media_file_ids)==null?void 0:_e.length)??0)>0,[L,G]=l.useState(t.invoice_number||""),[b,P]=l.useState(t.invoice_date||""),[w,T]=l.useState(t.voucher_type||"Purchase"),[U,M]=l.useState(t.supply_type||"Intra-State"),[Y,Z]=l.useState(t.reverse_charge||!1),[V,K]=l.useState(t.seller_name||""),[a,_]=l.useState(t.seller_gstin||""),[C,ue]=l.useState(t.seller_state_code||""),[se,ge]=l.useState(t.buyer_name||""),[te,pe]=l.useState(t.buyer_gstin||""),[q,je]=l.useState(t.buyer_state_code||""),[ae,W]=l.useState(t.line_items||[]),[fe,Ne]=l.useState(((ye=t.totals)==null?void 0:ye.round_off)||0),[J,X]=l.useState(!1);l.useEffect(()=>{var s;G(t.invoice_number||""),P(t.invoice_date||""),T(t.voucher_type||"Purchase"),M(t.supply_type||"Intra-State"),Z(t.reverse_charge||!1),K(t.seller_name||""),_(t.seller_gstin||""),ue(t.seller_state_code||""),ge(t.buyer_name||""),pe(t.buyer_gstin||""),je(t.buyer_state_code||""),W(t.line_items||[]),Ne(((s=t.totals)==null?void 0:s.round_off)||0)},[t.id]);const R=C!==q&&!!C&&!!q,f=t.totals||{taxable_amount:0,cgst_total:0,sgst_total:0,igst_total:0,cess_total:0,round_off:0,grand_total:0},O=(s,u,h)=>{W(F=>{const D=[...F];return D[s]={...D[s],[u]:h},D[s]=be(D[s],R),D})},Te=()=>W(s=>[...s,be(qe(),R)]),ke=s=>{W(u=>u.filter((h,F)=>F!==s))},ve=()=>({invoice_number:L,invoice_date:b,voucher_type:w,supply_type:U,reverse_charge:Y,seller_name:V,seller_gstin:a,seller_state_code:C,buyer_name:se,buyer_gstin:te,buyer_state_code:q,line_items:ae,totals:{...f,round_off:fe}}),Ae=async()=>{X(!0);try{await k.updateInvoice(t.id,ve()),y({title:"Invoice saved"}),A()}catch(s){y({title:"Save failed",description:s.message,variant:"destructive"})}finally{X(!1)}},Re=async()=>{X(!0);try{await k.updateInvoice(t.id,ve()),await k.approveInvoice(t.id),y({title:"Invoice approved"}),A(),c()}catch(s){y({title:"Approve failed",description:s.message,variant:"destructive"})}finally{X(!1)}};return e.jsxs(Pe,{className:`${I?"max-w-7xl":"max-w-4xl"} max-h-[90vh] overflow-y-auto`,children:[e.jsxs(De,{children:[H&&e.jsxs("div",{className:"flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 mb-2",children:[e.jsxs("span",{className:"text-sm text-blue-800 font-medium",children:[j.length," invoices extracted from this message"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{size:"sm",variant:"outline",className:"h-7 px-2",disabled:v===0,onClick:()=>B(s=>s-1),children:e.jsx(ie,{className:"h-3.5 w-3.5"})}),e.jsxs("span",{className:"text-sm font-medium text-blue-700 min-w-[60px] text-center",children:[v+1," of ",j.length]}),e.jsx(N,{size:"sm",variant:"outline",className:"h-7 px-2",disabled:v>=j.length-1,onClick:()=>B(s=>s+1),children:e.jsx(de,{className:"h-3.5 w-3.5"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ee,{className:"flex items-center gap-3",children:["Invoice #",t.invoice_number||"N/A",e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${Ie[t.status]||""}`,children:t.status.replace(/_/g," ")}),t.wa_confirmed&&e.jsx(Q,{className:"bg-green-50 text-green-700 text-xs",children:"WA Confirmed"})]}),Ve(t.confidence_score||0)]})]}),e.jsxs("div",{className:`${I?"grid grid-cols-5 gap-6":""}`,children:[I&&e.jsx("div",{className:"col-span-2",children:e.jsx(Qe,{invoiceId:t.id})}),e.jsxs("div",{className:`${I?"col-span-3":""} space-y-6 text-sm`,children:[i&&e.jsxs("div",{className:"flex items-start gap-3 bg-amber-50 border border-amber-200 rounded-lg px-4 py-3",children:[e.jsx(Oe,{className:"h-4 w-4 text-amber-600 mt-0.5 shrink-0"}),e.jsx("p",{className:"text-amber-800 text-sm",children:"Review extracted data. Edit any incorrect fields before approving."})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Invoice Number"}),i?e.jsx(p,{value:L,onChange:s=>G(s.target.value),className:"mt-1"}):e.jsx("p",{className:"font-medium mt-1",children:L||"—"})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Invoice Date"}),i?e.jsx(p,{type:"date",value:b,onChange:s=>P(s.target.value),className:"mt-1"}):e.jsx("p",{className:"font-medium mt-1",children:b||"—"})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Voucher Type"}),i?e.jsxs(ne,{value:w,onValueChange:T,children:[e.jsx(re,{className:"mt-1",children:e.jsx(le,{})}),e.jsx(ce,{children:Me.map(s=>e.jsx(ee,{value:s,children:s},s))})]}):e.jsx("p",{className:"font-medium mt-1",children:w})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Supply Type"}),i?e.jsxs(ne,{value:U,onValueChange:M,children:[e.jsx(re,{className:"mt-1",children:e.jsx(le,{})}),e.jsx(ce,{children:Ye.map(s=>e.jsx(ee,{value:s,children:s},s))})]}):e.jsx("p",{className:"font-medium mt-1",children:U})]})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[t.invoice_type&&e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Invoice Type"}),e.jsx("p",{className:"font-medium mt-1",children:t.invoice_type})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Reverse Charge"}),i?e.jsxs(ne,{value:Y?"Yes":"No",onValueChange:s=>Z(s==="Yes"),children:[e.jsx(re,{className:"mt-1",children:e.jsx(le,{})}),e.jsxs(ce,{children:[e.jsx(ee,{value:"No",children:"No"}),e.jsx(ee,{value:"Yes",children:"Yes"})]})]}):e.jsx("p",{className:"font-medium mt-1",children:Y?"Yes":"No"})]}),t.client_name&&e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Client"}),e.jsx("p",{className:"font-medium mt-1",children:t.client_name})]}),t.sender_phone&&e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Sender Phone"}),e.jsx("p",{className:"font-medium mt-1 font-mono text-xs",children:t.sender_phone})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3 p-4 rounded-lg bg-gray-50",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Seller"}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Name"}),i?e.jsx(p,{value:V,onChange:s=>K(s.target.value),className:"mt-1"}):e.jsx("p",{className:"font-medium mt-1",children:V})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"GSTIN"}),i?e.jsx(p,{value:a,onChange:s=>_(s.target.value.toUpperCase()),maxLength:15,placeholder:"27ABCDE1234F1Z5",className:"mt-1 font-mono text-xs"}):e.jsx("p",{className:"font-mono text-xs mt-1",children:a||"N/A"})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"State Code"}),i?e.jsx(p,{value:C,onChange:s=>ue(s.target.value),maxLength:2,className:"mt-1 w-20"}):e.jsx("p",{className:"font-medium mt-1",children:C||"—"})]}),t.seller_state_name&&e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"State"}),e.jsx("p",{className:"font-medium mt-1",children:t.seller_state_name})]})]})]}),e.jsxs("div",{className:"space-y-3 p-4 rounded-lg bg-gray-50",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider",children:"Buyer"}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"Name"}),i?e.jsx(p,{value:se,onChange:s=>ge(s.target.value),className:"mt-1"}):e.jsx("p",{className:"font-medium mt-1",children:se})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"GSTIN"}),i?e.jsx(p,{value:te,onChange:s=>pe(s.target.value.toUpperCase()),maxLength:15,placeholder:"27ABCDE1234F1Z5",className:"mt-1 font-mono text-xs"}):e.jsx("p",{className:"font-mono text-xs mt-1",children:te||"N/A"})]}),e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"State Code"}),i?e.jsx(p,{value:q,onChange:s=>je(s.target.value),maxLength:2,className:"mt-1 w-20"}):e.jsx("p",{className:"font-medium mt-1",children:q||"—"})]}),t.buyer_state_name&&e.jsxs("div",{children:[e.jsx(g,{className:"text-xs text-gray-500",children:"State"}),e.jsx("p",{className:"font-medium mt-1",children:t.buyer_state_name})]})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("p",{className:"font-semibold text-gray-900",children:"Line Items"}),i&&e.jsxs(N,{size:"sm",variant:"outline",onClick:Te,className:"gap-1.5",children:[e.jsx($e,{className:"h-3.5 w-3.5"})," Add Item"]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(xe,{children:[e.jsx(me,{children:e.jsxs(E,{children:[e.jsx(x,{className:"min-w-[150px]",children:"Description"}),e.jsx(x,{className:"w-[80px]",children:"HSN/SAC"}),e.jsx(x,{className:"w-[55px] text-right",children:"Qty"}),e.jsx(x,{className:"w-[50px]",children:"Unit"}),e.jsx(x,{className:"w-[80px] text-right",children:"Rate"}),e.jsx(x,{className:"w-[90px] text-right",children:"Taxable"}),e.jsx(x,{className:"w-[55px] text-right",children:"GST%"}),!R&&e.jsx(x,{className:"w-[80px] text-right",children:"CGST"}),!R&&e.jsx(x,{className:"w-[80px] text-right",children:"SGST"}),R&&e.jsx(x,{className:"w-[80px] text-right",children:"IGST"}),e.jsx(x,{className:"w-[90px] text-right",children:"Total"}),i&&e.jsx(x,{className:"w-[40px]"})]})}),e.jsxs(he,{children:[ae.map((s,u)=>e.jsxs(E,{children:[e.jsx(o,{children:i?e.jsx(p,{value:s.description,onChange:h=>O(u,"description",h.target.value),className:"h-8 text-xs"}):e.jsx("span",{className:"truncate block max-w-[180px]",children:s.description})}),e.jsx(o,{children:i?e.jsx(p,{value:s.hsn_sac_code,onChange:h=>O(u,"hsn_sac_code",h.target.value),className:"h-8 text-xs"}):s.hsn_sac_code||"—"}),e.jsx(o,{className:"text-right",children:i?e.jsx(p,{type:"number",value:s.quantity,onChange:h=>O(u,"quantity",parseFloat(h.target.value)||0),className:"h-8 text-xs text-right w-14",min:0,step:"any"}):s.quantity}),e.jsx(o,{children:i?e.jsx(p,{value:s.unit,onChange:h=>O(u,"unit",h.target.value),className:"h-8 text-xs w-14"}):s.unit}),e.jsx(o,{className:"text-right font-mono",children:i?e.jsx(p,{type:"number",value:s.rate,onChange:h=>O(u,"rate",parseFloat(h.target.value)||0),className:"h-8 text-xs text-right w-20",min:0,step:"any"}):d(s.rate)}),e.jsx(o,{className:"text-right font-mono",children:d(s.taxable_amount)}),e.jsx(o,{className:"text-right",children:i?e.jsx(p,{type:"number",value:s.gst_rate,onChange:h=>O(u,"gst_rate",parseFloat(h.target.value)||0),className:"h-8 text-xs text-right w-14",min:0,max:28,step:"any"}):`${s.gst_rate}%`}),!R&&e.jsx(o,{className:"text-right font-mono text-xs",children:d(s.cgst_amount)}),!R&&e.jsx(o,{className:"text-right font-mono text-xs",children:d(s.sgst_amount)}),R&&e.jsx(o,{className:"text-right font-mono text-xs",children:d(s.igst_amount)}),e.jsx(o,{className:"text-right font-mono font-medium",children:d(s.total_amount)}),i&&e.jsx(o,{children:e.jsx("button",{onClick:()=>ke(u),className:"p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50 transition-colors","aria-label":"Remove line item",children:e.jsx(He,{className:"h-3.5 w-3.5"})})})]},u)),ae.length===0&&e.jsx(E,{children:e.jsx(o,{colSpan:i?10:9,className:"text-center text-gray-400 py-6",children:"No line items"})})]})]})})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2 max-w-xs ml-auto text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Taxable Amount:"}),e.jsx("span",{className:"text-right font-mono",children:d(f.taxable_amount)}),(f.cgst_total>0||f.sgst_total>0)&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"CGST:"}),e.jsx("span",{className:"text-right font-mono",children:d(f.cgst_total)}),e.jsx("span",{className:"text-gray-500",children:"SGST:"}),e.jsx("span",{className:"text-right font-mono",children:d(f.sgst_total)})]}),f.igst_total>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"IGST:"}),e.jsx("span",{className:"text-right font-mono",children:d(f.igst_total)})]}),f.cess_total>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"Cess:"}),e.jsx("span",{className:"text-right font-mono",children:d(f.cess_total)})]}),e.jsx("span",{className:"text-gray-500",children:"Round Off:"}),e.jsx("span",{className:"text-right",children:i?e.jsx(p,{type:"number",value:fe,onChange:s=>Ne(parseFloat(s.target.value)||0),className:"h-7 text-xs text-right w-24 ml-auto",step:"0.01"}):e.jsx("span",{className:"font-mono",children:d(f.round_off)})}),e.jsx("span",{className:"font-bold text-gray-900",children:"Grand Total:"}),e.jsx("span",{className:"text-right font-bold font-mono text-gray-900",children:d(f.grand_total)})]}),f.amount_in_words&&e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-right italic",children:f.amount_in_words})]}),t.additional_charges&&(()=>{const s=t.additional_charges;return(s.service_charge||0)>0||(s.delivery_charge||0)>0||(s.packaging_charge||0)>0||(s.tips_gratuity||0)>0||(s.convenience_fee||0)>0||(s.other_charges||0)>0?e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("p",{className:"font-semibold text-gray-900 mb-2",children:"Additional Charges"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 max-w-xs text-sm",children:[(s.service_charge||0)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-gray-500",children:["Service Charge",s.service_charge_rate?` (${s.service_charge_rate}%)`:"",":"]}),e.jsx("span",{className:"text-right font-mono",children:d(s.service_charge)})]}),(s.delivery_charge||0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"Delivery:"}),e.jsx("span",{className:"text-right font-mono",children:d(s.delivery_charge)})]}),(s.packaging_charge||0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"Packaging:"}),e.jsx("span",{className:"text-right font-mono",children:d(s.packaging_charge)})]}),(s.tips_gratuity||0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"Tips/Gratuity:"}),e.jsx("span",{className:"text-right font-mono",children:d(s.tips_gratuity)})]}),(s.convenience_fee||0)>0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"Convenience Fee:"}),e.jsx("span",{className:"text-right font-mono",children:d(s.convenience_fee)})]}),(s.other_charges||0)>0&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"text-gray-500",children:[s.other_charges_description||"Other",":"]}),e.jsx("span",{className:"text-right font-mono",children:d(s.other_charges)})]})]})]}):null})(),t.discount&&(t.discount.discount_amount||0)>0&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("p",{className:"font-semibold text-gray-900 mb-2",children:"Discount"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 max-w-xs text-sm",children:[e.jsxs("span",{className:"text-gray-500",children:["Amount",t.discount.discount_percentage?` (${t.discount.discount_percentage}%)`:"",":"]}),e.jsxs("span",{className:"text-right font-mono text-green-700",children:["-",d(t.discount.discount_amount)]}),t.discount.discount_description&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"Description:"}),e.jsx("span",{className:"text-right",children:t.discount.discount_description})]}),t.discount.coupon_code&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-500",children:"Coupon:"}),e.jsx("span",{className:"text-right font-mono",children:t.discount.coupon_code})]})]})]}),t.extraction_notes&&e.jsxs("p",{className:"text-xs text-gray-400",children:["Notes: ",t.extraction_notes]})]})]}),e.jsx(ze,{children:i?e.jsxs("div",{className:"flex gap-2 w-full justify-end",children:[e.jsx(N,{variant:"outline",onClick:()=>{S(t.id),c()},disabled:J,children:"Reject"}),e.jsxs(N,{variant:"outline",onClick:Ae,disabled:J,className:"gap-1.5",children:[e.jsx(Ue,{className:"h-3.5 w-3.5"}),J?"Saving...":"Save"]}),e.jsxs(N,{onClick:Re,disabled:J,className:"gap-1.5",children:[e.jsx(we,{className:"h-3.5 w-3.5"}),J?"Approving...":"Save & Approve"]})]}):e.jsx(N,{variant:"outline",onClick:c,children:"Close"})})]})}function ms({config:r}){const{toast:n}=Se(),[c,m]=l.useState([]),[S,A]=l.useState(0),[y,j]=l.useState(!0),[v,B]=l.useState(""),[t,H]=l.useState(""),[i,I]=l.useState(new Set),[L,G]=l.useState(null),[b,P]=l.useState(0),w=25,T=l.useCallback(async()=>{j(!0);try{const a=await k.listInvoices({search:v||void 0,status:t||void 0,limit:w,offset:b*w});m(a.data||[]),A(a.total||0)}catch(a){n({title:"Error",description:a.message,variant:"destructive"})}finally{j(!1)}},[v,t,b,n]);l.useEffect(()=>{T()},[T]);const U=async a=>{try{await k.approveInvoice(a),n({title:"Invoice approved"}),T()}catch(_){n({title:"Error",description:_.message,variant:"destructive"})}},M=async a=>{try{await k.rejectInvoice(a),n({title:"Invoice rejected"}),T()}catch(_){n({title:"Error",description:_.message,variant:"destructive"})}},Y=async()=>{if(i.size!==0)try{const a=await k.bulkApproveInvoices(Array.from(i));n({title:`${a.modified_count} invoices approved`}),I(new Set),T()}catch(a){n({title:"Error",description:a.message,variant:"destructive"})}},Z=a=>{I(_=>{const C=new Set(_);return C.has(a)?C.delete(a):C.add(a),C})},V=()=>{i.size===c.length?I(new Set):I(new Set(c.map(a=>a.id)))},K=[{value:"",label:"All"},{value:"pending_review",label:"Pending Review"},{value:"pending_user_confirmation",label:"Awaiting Confirmation"},{value:"approved",label:"Approved"},{value:"rejected",label:"Rejected"},{value:"exported",label:"Exported"}];return e.jsxs("div",{className:"rounded-xl border bg-white overflow-hidden",children:[e.jsxs("div",{className:"px-5 pt-5 pb-4 border-b space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx(Be,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-neutral-400"}),e.jsx(p,{placeholder:"Search invoices…",value:v,onChange:a=>{B(a.target.value),P(0)},className:"pl-9 h-9"})]}),i.size>0&&e.jsxs(N,{size:"sm",onClick:Y,className:"shrink-0",children:[e.jsx(we,{className:"h-3.5 w-3.5 mr-1.5"}),"Approve ",i.size," selected"]})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:K.map(a=>e.jsx("button",{onClick:()=>{H(a.value),P(0)},className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${t===a.value?"bg-neutral-900 text-white":"bg-neutral-100 text-neutral-600 hover:bg-neutral-200"}`,children:a.label},a.value))})]}),e.jsx("div",{className:"overflow-x-auto",children:y?e.jsx("div",{className:"p-5 space-y-3",children:[...Array(5)].map((a,_)=>e.jsx(oe,{className:"h-11 w-full"},_))}):e.jsxs(xe,{children:[e.jsx(me,{children:e.jsxs(E,{className:"bg-neutral-50/70",children:[e.jsx(x,{className:"w-10 pl-5",children:e.jsx("input",{type:"checkbox",className:"rounded border-neutral-300 accent-neutral-900",checked:i.size===c.length&&c.length>0,onChange:V})}),e.jsx(x,{className:"font-medium text-neutral-600",children:"Invoice #"}),e.jsx(x,{className:"font-medium text-neutral-600",children:"Date"}),e.jsx(x,{className:"font-medium text-neutral-600",children:"Seller"}),e.jsx(x,{className:"font-medium text-neutral-600",children:"Type"}),e.jsx(x,{className:"text-right font-medium text-neutral-600",children:"Amount"}),e.jsx(x,{className:"font-medium text-neutral-600",children:"Status"}),e.jsx(x,{className:"font-medium text-neutral-600",children:"Actions"})]})}),e.jsxs(he,{children:[c.map(a=>{var _;return e.jsxs(E,{className:"hover:bg-neutral-50/60 transition-colors",children:[e.jsx(o,{className:"pl-5",children:e.jsx("input",{type:"checkbox",className:"rounded border-neutral-300 accent-neutral-900",checked:i.has(a.id),onChange:()=>Z(a.id)})}),e.jsx(o,{children:e.jsx("button",{className:"text-indigo-600 hover:text-indigo-800 hover:underline font-medium text-sm",onClick:()=>G(a),children:a.invoice_number||"—"})}),e.jsx(o,{className:"text-sm text-neutral-600",children:a.invoice_date||"—"}),e.jsx(o,{className:"text-sm text-neutral-700 max-w-[200px] truncate",children:a.seller_name}),e.jsx(o,{children:e.jsx(Q,{variant:"outline",className:"text-xs",children:a.voucher_type||a.invoice_type})}),e.jsx(o,{className:"text-right font-mono text-sm font-medium text-neutral-900",children:d(((_=a.totals)==null?void 0:_.grand_total)||0)}),e.jsx(o,{children:e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${Ie[a.status]||""}`,children:a.status.replace(/_/g," ")})}),e.jsx(o,{children:(a.status==="pending_review"||a.status==="pending_user_confirmation")&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx(N,{size:"sm",variant:"ghost",className:"h-7 text-xs text-emerald-700 hover:bg-emerald-50",onClick:()=>U(a.id),children:"Approve"}),e.jsx(N,{size:"sm",variant:"ghost",className:"h-7 text-xs text-red-600 hover:bg-red-50",onClick:()=>M(a.id),children:"Reject"})]})})]},a.id)}),c.length===0&&e.jsx(E,{children:e.jsx(o,{colSpan:8,className:"text-center py-16",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 text-neutral-400",children:[e.jsx(Ge,{className:"h-8 w-8"}),e.jsx("p",{className:"text-sm font-medium",children:"No invoices found"}),e.jsx("p",{className:"text-xs",children:"Try adjusting your search or status filter"})]})})})]})]})}),S>w&&e.jsxs("div",{className:"flex items-center justify-between px-5 py-3 border-t bg-neutral-50/50",children:[e.jsxs("span",{className:"text-xs text-neutral-500",children:["Showing ",b*w+1,"–",Math.min((b+1)*w,S)," of ",S]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{size:"sm",variant:"outline",disabled:b===0,onClick:()=>P(b-1),children:[e.jsx(ie,{className:"h-3.5 w-3.5 mr-1"})," Prev"]}),e.jsxs(N,{size:"sm",variant:"outline",disabled:(b+1)*w>=S,onClick:()=>P(b+1),children:["Next ",e.jsx(de,{className:"h-3.5 w-3.5 ml-1"})]})]})]}),e.jsx(Le,{open:!!L,onOpenChange:()=>G(null),children:L&&e.jsx(Ze,{invoice:L,allInvoices:c,onClose:()=>G(null),onApprove:U,onReject:M,onSaved:T})})]})}export{ms as default};
