import{r as a,z as g,s as t,j as re,i as L,t as z,Q as i,F as le}from"./index-Bp_UmaCL.js";import{B as R,I as ie}from"./input-GzHbweEW.js";import{B as T}from"./badge-BsIsCzmH.js";import{A as O,a as P,T as ce}from"./textarea-CYHZra62.js";import{S as oe}from"./scroll-area-ftSbuGQS.js";import{R as de}from"./refresh-cw-B2lhsbeL.js";import{S as xe}from"./search-hwF9FksX.js";import{L as U}from"./loader-2-B7eL5lYw.js";import{B as Q,S as me,U as W,C as q}from"./user-CRRRzQSu.js";import{C as K}from"./check-DoRmBi-x.js";import{A as ue}from"./arrow-left-BmyiyaPF.js";import{I as he}from"./image-CYuOe6MX.js";import{C as fe}from"./clock-BMq5U3Dh.js";import"./index-CvZeWDWn.js";const pe=a.memo(function({src:f,alt:_,className:s,onClick:N}){const[c,m]=a.useState(null),[o,w]=a.useState(!1);return a.useEffect(()=>{if(!f)return;let p=!1;return g.get(f,{responseType:"blob"}).then(y=>{p||m(URL.createObjectURL(y.data))}).catch(()=>{p||w(!0)}),()=>{p=!0}},[f]),a.useEffect(()=>()=>{c&&URL.revokeObjectURL(c)},[c]),o||!c?t.jsxs("div",{className:i("flex items-center gap-1.5 text-xs py-1 italic text-neutral-400",s),children:[t.jsx(he,{className:"w-3 h-3"})," ",o?"Image unavailable":"Loading..."]}):t.jsx("img",{src:c,alt:_,className:s,loading:"lazy",onClick:N})});function Ue({config:b}){const[f,_]=a.useState([]),[s,N]=a.useState(null),[c,m]=a.useState([]),[o,w]=a.useState(""),[p,y]=a.useState(!1),[C,V]=a.useState(""),[H,S]=a.useState(!0),[Y,I]=a.useState(!1),[M,$]=a.useState(!1),A=a.useRef(null),k=a.useRef(),j=(b==null?void 0:b.endpoint)||"/api/conversations",u=a.useCallback(async()=>{var e;try{const n=await g.get(j),r=((e=n.data)==null?void 0:e.data)||n.data||[];_(r)}catch(n){console.error("Failed to load conversations:",n)}finally{S(!1)}},[j]);a.useEffect(()=>{u()},[u]);const v=a.useCallback(async e=>{var n;I(!0);try{const r=await g.get(`${j}/${e}/messages?limit=200`);m(((n=r.data)==null?void 0:n.data)||r.data||[])}catch(r){console.error("Failed to load messages:",r)}finally{I(!1)}},[j]);a.useEffect(()=>{s?v(s.phone):m([])},[s,v]),a.useEffect(()=>{var e;(e=A.current)==null||e.scrollIntoView({behavior:"smooth"})},[c]),a.useEffect(()=>(s&&(k.current=setInterval(()=>{v(s.phone),u()},1e4)),()=>{k.current&&clearInterval(k.current)}),[s,v,u]);const G=e=>{N(e),$(!0)},J=()=>{$(!1),N(null)},E=a.useCallback(async()=>{var r;if(!s||!o.trim())return;y(!0);const e={id:`temp_${Date.now()}`,sender_phone:s.phone,direction:"outgoing",type:"text",text:o.trim(),source:"human",timestamp:new Date().toISOString(),status:"sending"};m(d=>[...d,e]);const n=o.trim();w("");try{const l=(r=(await g.post(`${j}/${s.phone}/send`,{text:n})).data)==null?void 0:r.data;m(x=>x.map(h=>h.id===e.id?{...h,id:(l==null?void 0:l.id)||h.id,status:"sent",wa_message_id:l==null?void 0:l.wa_message_id}:h)),u()}catch(d){m(l=>l.map(x=>x.id===e.id?{...x,status:"failed"}:x)),console.error("Failed to send:",d)}finally{y(!1)}},[s,o,j,u]),D=f.filter(e=>{if(!C)return!0;const n=C.toLowerCase();return e.phone.includes(n)||(e.sender_name||"").toLowerCase().includes(n)||(e.client_name||"").toLowerCase().includes(n)}),X=e=>{if(!e)return"";const n=new Date(e),d=new Date().getTime()-n.getTime(),l=Math.floor(d/6e4),x=Math.floor(d/36e5),h=Math.floor(d/864e5);return l<1?"now":l<60?`${l}m`:x<24?`${x}h`:h<7?`${h}d`:n.toLocaleDateString("en-US",{month:"short",day:"numeric"})},Z=e=>e?new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):"",ee=e=>{switch(e){case"read":return t.jsx(q,{className:"w-3 h-3 text-blue-500"});case"delivered":return t.jsx(q,{className:"w-3 h-3 text-neutral-400"});case"sent":return t.jsx(K,{className:"w-3 h-3 text-neutral-400"});case"sending":return t.jsx(fe,{className:"w-3 h-3 text-neutral-400 animate-pulse"});case"failed":return t.jsx("span",{className:"text-[10px] text-red-500 font-medium",children:"Failed"});default:return null}},te=(e,n)=>n==="incoming"?t.jsx(W,{className:"w-3 h-3"}):e==="bot"?t.jsx(Q,{className:"w-3 h-3"}):t.jsx(W,{className:"w-3 h-3"}),se=e=>e.direction==="incoming"?e.sender_name||"Client":e.source==="bot"?"Bot":"You",F=e=>e.client_name?e.client_name.slice(0,2).toUpperCase():e.sender_name?e.sender_name.slice(0,2).toUpperCase():e.phone.slice(-2),B=e=>e.client_name||e.sender_name||e.display_phone,ae=()=>t.jsxs("div",{className:i("border-r border-neutral-200 flex flex-col h-full",M?"hidden lg:flex":"flex","lg:w-[340px] w-full"),children:[t.jsxs("div",{className:"p-4 border-b border-neutral-100 flex-shrink-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("h3",{className:"font-semibold flex items-center gap-2 text-sm",children:[t.jsx(re,{className:"w-4 h-4 text-green-600"}),"WhatsApp Messages"]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(T,{variant:"secondary",className:"text-xs",children:f.length}),t.jsx(R,{variant:"ghost",size:"icon",className:"w-7 h-7",onClick:()=>{S(!0),u().finally(()=>S(!1))},children:t.jsx(de,{className:"w-3.5 h-3.5"})})]})]}),t.jsxs("div",{className:"relative",children:[t.jsx(xe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-400"}),t.jsx(ie,{placeholder:"Search by name or phone...",value:C,onChange:e=>V(e.target.value),className:"pl-9 h-9 text-sm"})]})]}),t.jsx(oe,{className:"flex-1",children:H?t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx(U,{className:"w-6 h-6 animate-spin text-neutral-400"})}):D.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-40 text-neutral-500 px-4",children:[t.jsx(L,{className:"w-8 h-8 mb-2 opacity-40"}),t.jsx("p",{className:"text-sm font-medium",children:"No conversations yet"}),t.jsx("p",{className:"text-xs text-neutral-400 text-center mt-1",children:"Messages from WhatsApp will appear here"})]}):t.jsx("div",{className:"divide-y divide-neutral-100",children:D.map(e=>t.jsxs(z.button,{onClick:()=>G(e),whileHover:{backgroundColor:"rgba(0,0,0,0.02)"},className:i("w-full p-3 flex items-start gap-3 text-left transition-colors",(s==null?void 0:s.phone)===e.phone&&"bg-green-50/60"),children:[t.jsx(O,{className:"w-10 h-10 flex-shrink-0",children:t.jsx(P,{className:"bg-green-100 text-green-700 text-xs font-medium",children:F(e)})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[t.jsx("span",{className:"font-medium text-sm truncate",children:B(e)}),t.jsx("span",{className:"text-[11px] text-neutral-400 flex-shrink-0 ml-2",children:X(e.last_message_time)})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[e.last_direction==="outgoing"&&t.jsx("span",{className:"text-neutral-400 flex-shrink-0",children:e.last_source==="bot"?t.jsx(Q,{className:"w-3 h-3 inline"}):t.jsx(K,{className:"w-3 h-3 inline"})}),t.jsx("p",{className:"text-xs text-neutral-500 truncate",children:e.last_message_type!=="text"?`[${e.last_message_type}]`:e.last_message||"..."})]}),e.client_name&&e.sender_name&&e.client_name!==e.sender_name&&t.jsx("p",{className:"text-[11px] text-neutral-400 truncate mt-0.5",children:e.display_phone})]}),t.jsx(T,{variant:"outline",className:"text-[10px] px-1.5 py-0 flex-shrink-0 mt-1",children:e.total_messages})]},e.phone))})})]}),ne=()=>t.jsx("div",{className:i("flex flex-col h-full flex-1",!M&&"hidden lg:flex"),children:s?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"px-4 py-3 border-b border-neutral-100 flex items-center gap-3 bg-neutral-50/80 flex-shrink-0",children:[t.jsx(R,{variant:"ghost",size:"icon",className:"w-8 h-8 lg:hidden",onClick:J,children:t.jsx(ue,{className:"w-4 h-4"})}),t.jsx(O,{className:"w-9 h-9",children:t.jsx(P,{className:"bg-green-100 text-green-700 text-xs font-medium",children:F(s)})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"font-medium text-sm truncate",children:B(s)}),t.jsxs("p",{className:"text-xs text-neutral-500 truncate",children:[s.display_phone,s.client_name&&` · ${s.client_name}`]})]}),t.jsxs(T,{variant:"outline",className:"text-xs",children:[s.total_messages," msgs"]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3",children:Y?t.jsx("div",{className:"flex items-center justify-center h-32",children:t.jsx(U,{className:"w-5 h-5 animate-spin text-neutral-400"})}):c.length===0?t.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-neutral-400",children:[t.jsx(L,{className:"w-6 h-6 mb-2"}),t.jsx("p",{className:"text-sm",children:"No messages yet"})]}):t.jsxs("div",{className:"space-y-2",children:[c.map(e=>t.jsx(z.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},transition:{duration:.15},className:i("flex",e.direction==="outgoing"?"justify-end":"justify-start"),children:t.jsxs("div",{className:i("max-w-[75%] rounded-2xl px-3 py-2 shadow-sm",e.direction==="outgoing"?e.source==="bot"?"bg-blue-50 text-neutral-900 border border-blue-100":"bg-green-600 text-white":"bg-white text-neutral-900 border border-neutral-200"),children:[t.jsxs("div",{className:i("flex items-center gap-1 text-[11px] mb-0.5",e.direction==="outgoing"?e.source==="bot"?"text-blue-500":"text-green-100":"text-neutral-400"),children:[te(e.source,e.direction),t.jsx("span",{children:se(e)})]}),e.type==="image"&&e.media_url&&t.jsx("div",{className:"mb-1.5 rounded-lg overflow-hidden",children:t.jsx(pe,{src:e.media_url,alt:"Shared image",className:"max-w-full max-h-[240px] rounded-lg object-contain bg-neutral-100 cursor-pointer"})}),e.type==="document"&&t.jsxs("div",{className:i("flex items-center gap-2 mb-1.5 px-2 py-1.5 rounded-lg text-xs",e.direction==="outgoing"&&e.source!=="bot"?"bg-green-700/30 text-green-50":"bg-neutral-100 text-neutral-600"),children:[t.jsx(le,{className:"w-4 h-4 flex-shrink-0"}),t.jsx("span",{className:"truncate",children:e.media_filename||"Document"}),e.media_url&&t.jsx("button",{onClick:()=>{g.get(e.media_url,{responseType:"blob"}).then(n=>{const r=URL.createObjectURL(n.data);window.open(r,"_blank"),setTimeout(()=>URL.revokeObjectURL(r),6e4)}).catch(()=>console.error("Failed to load document"))},className:"ml-auto underline flex-shrink-0 hover:opacity-80",children:"View"})]}),e.type!=="text"&&e.type!=="unknown"&&e.type!=="image"&&e.type!=="document"&&t.jsxs("div",{className:i("text-xs mb-1 italic",e.direction==="outgoing"&&e.source!=="bot"?"text-green-100":"text-neutral-400"),children:["[",e.type,e.media_filename?`: ${e.media_filename}`:"","]"]}),t.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:e.text||`[${e.type}]`}),t.jsxs("div",{className:i("flex items-center justify-end gap-1 mt-0.5 text-[10px]",e.direction==="outgoing"?e.source==="bot"?"text-blue-400":"text-green-200":"text-neutral-400"),children:[Z(e.timestamp),e.direction==="outgoing"&&ee(e.status)]})]})},e.id)),t.jsx("div",{ref:A})]})}),t.jsxs("div",{className:"px-4 py-3 border-t border-neutral-100 bg-white flex-shrink-0",children:[t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx(ce,{placeholder:"Type a message...",value:o,onChange:e=>w(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),E())},className:"min-h-[42px] max-h-[120px] resize-none text-sm flex-1",rows:1}),t.jsx(R,{onClick:E,disabled:!o.trim()||p,className:"h-[42px] px-4 bg-green-600 hover:bg-green-700 text-white flex-shrink-0",children:p?t.jsx(U,{className:"w-4 h-4 animate-spin"}):t.jsx(me,{className:"w-4 h-4"})})]}),t.jsx("p",{className:"text-[11px] text-neutral-400 mt-1.5",children:"Shift+Enter for new line · Replies sent as your business number"})]})]}):t.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-neutral-400",children:[t.jsx("div",{className:"w-16 h-16 rounded-full bg-green-50 flex items-center justify-center mb-4",children:t.jsx(L,{className:"w-8 h-8 text-green-300"})}),t.jsx("p",{className:"font-medium text-neutral-600 mb-1",children:"Select a conversation"}),t.jsx("p",{className:"text-sm text-center max-w-xs",children:"Choose a conversation to view messages and reply"})]})});return t.jsxs("div",{className:"flex h-[600px] bg-white rounded-xl border border-neutral-200 overflow-hidden",children:[t.jsx(ae,{}),t.jsx(ne,{})]})}export{Ue as default};
